var paths=require("../config/paths");var path=require("path");var ucfirst=require("ucfirst");var file=require("../config/file");var mongoose=require("mongoose");var FieldError=require("./FieldError");var moment=require("moment");var app_config=require(paths("appConfig"));var db_registry=require("./DbRegistry");var mongoosePaginate=require("mongoose-paginate");module.exports={models:[],configs:[],get:function(b){var c=this;if(c.models[b]==undefined){var e=c.getModelConfig(b);var f=e.defaultConnection!=undefined?e.defaultConnection:"default";var a=db_registry.get(f);var g=new mongoose.Schema(e._schema);g.plugin(mongoosePaginate);Object.keys(e._methods).forEach(function(h){g.methods[h]=e._methods[h]});Object.keys(e._statics).forEach(function(h){g.statics[h]=e._statics[h]});Object.keys(e._virtuals).forEach(function(i){var h=e._virtuals[i];if(h.get!=undefined&&typeof h.get=="function"){g.virtual(i).get(h.get)}if(h.set!=undefined&&typeof h.get=="function"){g.virtual(i).set(h.set)}});var d=a.model(b,g);c.prepareModelCallbacks(e._schema,g,d);c.models[b]=d}return c.models[b]},getModelConfig:function(a){a=ucfirst(a);var b=this;if(b.configs[a]==undefined){var c=path.join(paths("models"),a);b.configs[a]=require(c)}return b.configs[a]},prepareModelCallbacks:function(fields,schema,model,parent){var self=this;Object.keys(fields).forEach(function(key){var field=fields[key];var fieldName=parent==undefined?key:parent+"."+key;if(field.constructor=={}.constructor&&field.type==undefined){self.prepareModelCallbacks(field,schema,model,fieldName)}else{if(field.unique||field.index&&field.index.unique){schema.post("validate",function(doc,next,err){var conditions={};conditions[fieldName]=eval("doc."+fieldName);model.find(conditions,function(err,docs){if(!docs.length){next()}else{var error=new FieldError(fieldName,"Campo não é unico",{kind:"unique",message:"O campo "+fieldName+" é unico",path:fieldName,value:doc[fieldName]});next(error)}})})}}if(field.type==Date){schema.pre("validate",function(next){moment.locale(app_config.defaultLocale.lang);var data=moment(this[key]);if(data.isValid()){eval("this."+fieldName+" = data.toDate()");next()}else{var error=new FieldError(key,"Data inválida",{kind:"Date",message:"Essa data é inválida",path:key,value:this[key]});next(error)}})}})}};