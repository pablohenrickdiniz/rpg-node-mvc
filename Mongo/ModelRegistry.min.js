var paths=require("../config/paths");var ucfirst=require("ucfirst");var file=require("../config/file");var mongoose=require("mongoose");var FieldError=require("./FieldError");var moment=require("moment");var app_config=require(paths.APP_ROOT+"/config/app");var db_registry=require("./DbRegistry");var mongoosePaginate=require("mongoose-paginate");module.exports={models:[],configs:[],get:function(b){var c=this;if(c.models[b]==undefined){var e=c.getModelConfig(b);var a=db_registry.get("default");var f=new mongoose.Schema(e._schema);f.plugin(mongoosePaginate);Object.keys(e._methods).forEach(function(g){f.methods[g]=e._methods[g]});Object.keys(e._statics).forEach(function(g){f.statics[g]=e._statics[g]});Object.keys(e._virtuals).forEach(function(h){var g=e._virtuals[h];if(g.get!=undefined&&typeof g.get=="function"){f.virtual(h).get(g.get)}if(g.set!=undefined&&typeof g.get=="function"){f.virtual(h).set(g.set)}});var d=a.model(b,f);c.prepareModelCallbacks(e._schema,f,d);c.models[b]=d}return c.models[b]},getModelConfig:function(a){a=ucfirst(a);var b=this;if(b.configs[a]==undefined){var c=paths.APP_MODEL+"/"+a;b.configs[a]=require(c)}return b.configs[a]},prepareModelCallbacks:function(fields,schema,model,parent){var self=this;Object.keys(fields).forEach(function(key){var field=fields[key];var fieldName=parent==undefined?key:parent+"."+key;if(field.constructor=={}.constructor&&field.type==undefined){self.prepareModelCallbacks(field,schema,model,fieldName)}else{if(field.unique||field.index&&field.index.unique){schema.post("validate",function(doc,next,err){var conditions={};conditions[fieldName]=eval("doc."+fieldName);model.find(conditions,function(err,docs){if(!docs.length){next()}else{var error=new FieldError(fieldName,"Campo não é unico",{kind:"unique",message:"O campo "+fieldName+" é unico",path:fieldName,value:doc[fieldName]});next(error)}})})}}if(field.type==Date){schema.pre("validate",function(next){moment.locale(app_config.defaultLocale.lang);var data=moment(this[key]);if(data.isValid()){eval("this."+fieldName+" = data.toDate()");next()}else{var error=new FieldError(key,"Data inválida",{kind:"Date",message:"Essa data é inválida",path:key,value:this[key]});next(error)}})}})}};